<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Modern Causal Mediation Analysis - 6&nbsp; Some R packages for estimation of the causal (in)direct effects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../references.html" rel="next">
<link href="../chapters/estimation_natural_interv.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script>
  MathJax = {
    tex: {
      tags: 'ams',  // should be 'ams', 'none', or 'all'
      macros: {
        E: '{\\mathbb{E}}',
        V: '{\\mathbb{V}}',
        P: '{\\mathsf{P}}',
        M: '{\\mathsf{M}}',
        Pr: '{\\mathbb{P}}',
        R: '{\\mathbb{R}}',
        I: '{\\mathbb{I}}',
        1: '{\\mathbb{1}}',
        D: '{\\mathcal{D}}',
        F: '{\\mathcal{F}}',
        M: '{\\mathcal{M}}',
        C: '{\\mathcal{C}}',
        G: '{\\mathcal{G}}',
        X: '{\\mathcal{X}}',
        Z: '{\\mathcal{Z}}',
        Hold: '{\\mathcal{H}}',
        lik: '{\\mathcal{L}}',
        logit: '{\\operatorname{logit}}',
        expit: '{\\operatorname{expit}}',
        argmin: '{\\operatorname*{arg\\,min}}',
        argmax: '{\\operatorname*{arg\\,max}}',
        indep: '{\\perp\\!\\!\\!\\perp}',
        notindep: '{\\centernot{\\perp\\!\\!\\!\\perp}}',
        coloneqq: '{\\mathrel{\\vcenter{:}}=}',
        iid: '{\\,\\, \\mathbin{\\overset{\\text{iid}}{\\sim}} \\,\\,}',
        asto: '{\\mathbin{\\underset{a.s.}{\\to}}}',
        pto: '{\\mathbin{\\underset{p}{\\to}}}',
        dto: '{\\mathbin{\\underset{d}{\\to}}}'
      }
    }
  };
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/estimation_prelims.html">Estimation</a></li><li class="breadcrumb-item"><a href="../chapters/estimation_walkthrough.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Some <code>R</code> packages for estimation of the causal (in)direct effects</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../"><em>Modern</em> Causal Mediation Analysis</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/nhejazi/ser2024_mediation_workshop/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to SER 2024!</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Identification</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">What is causal mediation analysis?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/effects_defn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Types of path-specific causal mediation effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/how_to_choose.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">How to choose an estimand: Real-world example</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Estimation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/estimation_prelims.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Estimation preliminaries: Review of doubly robust estimators for the ATE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/estimation_natural_interv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Construction of G-computation and weighted estimators: The case of the NDE</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/estimation_walkthrough.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Some <code>R</code> packages for estimation of the causal (in)direct effects</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/additional_readings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Additional topics of interest</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/stochastic_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Stochastic direct and indirect effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time-varying treatments, mediators, and covariates</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul class="collapse">
<li><a href="#medoutcon-efficient-estimation-of-natural-and-interventional-indirect-effects" id="toc-medoutcon-efficient-estimation-of-natural-and-interventional-indirect-effects" class="nav-link active" data-scroll-target="#medoutcon-efficient-estimation-of-natural-and-interventional-indirect-effects"><span class="header-section-number">6.1</span> <code>medoutcon</code>: Efficient estimation of natural and interventional (in)direct effects</a></li>
  <li><a href="#natural-indirect-effects" id="toc-natural-indirect-effects" class="nav-link" data-scroll-target="#natural-indirect-effects"><span class="header-section-number">6.2</span> Natural (in)direct effects</a></li>
  <li><a href="#interventional-indirect-effects" id="toc-interventional-indirect-effects" class="nav-link" data-scroll-target="#interventional-indirect-effects"><span class="header-section-number">6.3</span> Interventional (in)direct effects</a></li>
  </ul><div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/nhejazi/ser2024_mediation_workshop/edit/master/chapters/estimation_walkthrough.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nhejazi/ser2024_mediation_workshop/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/estimation_prelims.html">Estimation</a></li><li class="breadcrumb-item"><a href="../chapters/estimation_walkthrough.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Some <code>R</code> packages for estimation of the causal (in)direct effects</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Some <code>R</code> packages for estimation of the causal (in)direct effects</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>We’ll now turn to working through a few examples of estimating the natural and interventional direct and indirect effects. Note that we will be using the <a href="https://github.com/nhejazi/medoutcon"><code>medoutcon</code> <code>R</code> package</a>, which supports multiple mediators and a single binary intermediate confounder, but, if your data scenario includes multiple mediators <em>and</em> <em>multiple</em> intermediate confounders, you should consider using the <a href="https://github.com/nt-williams/HDmediation"><code>HDmediation</code> <code>R</code> package</a> instead.</p>
<p>As our running example, we’ll use a simple data set from an observational study of the relationship between BMI and kids’ behavior, freely distributed with the <a href="https://CRAN.R-project.org/package=mma"><code>mma</code> <code>R</code> package on CRAN</a>. First, let’s load the packages we’ll be using and set a seed; then, load this data set and take a quick look.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(sl3)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(medoutcon)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(medshift)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(mma)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">set.seed</span>(<span class="dv">429153</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># load and examine data</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">data</span>(weight_behavior)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">dim</span>(weight_behavior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 691  15</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># drop missing values</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>weight_behavior <span class="ot">&lt;-</span> weight_behavior <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb4-5"><a href="#cb4-5"></a>weight_behavior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 567 × 15
     bmi   age sex   race  numpeople   car gotosch snack tvhours cmpthours
   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;     &lt;int&gt; &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1  18.2  12.2 F     OTHER         5     3 2       1           4         0
 2  22.8  12.8 M     OTHER         4     3 2       1           4         2
 3  25.6  12.1 M     OTHER         2     3 2       1           0         2
 4  15.1  12.3 M     OTHER         4     1 2       1           2         1
 5  23.0  11.8 M     OTHER         4     1 1       1           4         3
 6  19.2  12.1 F     OTHER         3     3 2       1           0         0
 7  16.6  12.4 M     OTHER         5     3 1       1           0         0
 8  22.1  11.9 F     OTHER         5     2 2       1           3         4
 9  15.9  12.4 F     OTHER         4     3 2       2           0         0
10  18.6  12.7 M     OTHER         5     3 2       1           0         0
# ℹ 557 more rows
# ℹ 5 more variables: cellhours &lt;dbl&gt;, sports &lt;fct&gt;, exercises &lt;int&gt;,
#   sweat &lt;int&gt;, overweigh &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The documentation for the data set describes it as a “database obtained from the Louisiana State University Health Sciences Center, New Orleans, by Dr.&nbsp;Richard Scribner. He explored the relationship between BMI and kids’ behavior through a survey at children, teachers and parents in Grenada in 2014. This data set includes 691 observations and 15 variables.” Note that the data set contained several observations with missing values, which we removed above to simplify the demonstration of our analytic methods. In practice, we recommend instead using appropriate corrections (e.g., imputation, inverse weighting) to fully take advantage of the observed data.</p>
<p>Following the motivation of the original study, we focus on the causal effects of participating in a sports team (<code>sports</code>) on the BMI of children (<code>bmi</code>), taking into consideration several mediators (<code>snack</code>, <code>exercises</code>, <code>overweigh</code>); all other measured covariates are taken to be potential baseline confounders.</p>
<section id="medoutcon-efficient-estimation-of-natural-and-interventional-indirect-effects" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="medoutcon-efficient-estimation-of-natural-and-interventional-indirect-effects">
<span class="header-section-number">6.1</span> <code>medoutcon</code>: Efficient estimation of natural and interventional (in)direct effects</h2>
<p>The data on a single observational unit can be represented <span class="math inline">\(O = (W, A, M, Y)\)</span>, with the data pooled across all participants denoted <span class="math inline">\(O_1, \ldots, O_n\)</span>, for a of <span class="math inline">\(n\)</span> i.i.d. observations of <span class="math inline">\(O\)</span>. Recall the DAG <a href="effects_defn.html">from an earlier chapter</a>, which represents the data-generating process:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="estimation_walkthrough_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Directed acyclic graph under <em>no intermediate confounders</em> of the mediator-outcome relation affected by treatment</figcaption></figure>
</div>
</div>
</div>
</section><section id="natural-indirect-effects" class="level2 page-columns page-full" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="natural-indirect-effects">
<span class="header-section-number">6.2</span> Natural (in)direct effects</h2>
<p>To start, we will consider estimation of the <em>natural</em> direct and indirect effects, which, we recall, are defined as follows</p>
<p><span class="math display">\[
  \E[Y_{1,M_1} - Y_{0,M_0}] =
    \underbrace{\E[Y_{\color{red}{1},\color{blue}{M_1}} -
    Y_{\color{red}{1},\color{blue}{M_0}}]}_{\text{natural indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{1},\color{red}{M_0}} -
    Y_{\color{blue}{0},\color{red}{M_0}}]}_{\text{natural direct effect}}.
\]</span></p>
<ul>
<li>Our <a href="https://github.com/nhejazi/medoutcon"><code>medoutcon</code> <code>R</code> package</a> <span class="citation" data-cites="hejazi2022medoutcon-rpkg hejazi2022medoutcon-joss">(<a href="../references.html#ref-hejazi2022medoutcon-rpkg" role="doc-biblioref">Hejazi, Dı́az, and Rudolph 2022</a>; <a href="../references.html#ref-hejazi2022medoutcon-joss" role="doc-biblioref">Hejazi, Rudolph, and Dı́az 2022</a>)</span>, which accompanies <span class="citation" data-cites="diaz2020nonparametric">Dı́az et al. (<a href="../references.html#ref-diaz2020nonparametric" role="doc-biblioref">2020</a>)</span>, implements one-step and TML estimators of both the natural and interventional (in)direct effects.</li>
<li>Both types of estimators are capable of accommodating flexible modeling strategies (e.g., ensemble machine learning) for the initial estimation of nuisance parameters.</li>
<li>The <code>medoutcon</code> <code>R</code> package uses cross-validation in initial estimation: this results in cross-validated (or “cross-fitted”) one-step and TML estimators <span class="citation" data-cites="klaassen1987consistent zheng2011cross chernozhukov2018double">(<a href="../references.html#ref-klaassen1987consistent" role="doc-biblioref">Klaassen 1987</a>; <a href="../references.html#ref-zheng2011cross" role="doc-biblioref">Zheng and van der Laan 2011</a>; <a href="../references.html#ref-chernozhukov2018double" role="doc-biblioref">Chernozhukov et al. 2018</a>)</span>, which exhibit greater robustness than their non-sample-splitting analogs.</li>
<li>To this end, <code>medoutcon</code> integrates with the <code>sl3</code> <code>R</code> package <span class="citation" data-cites="coyle2022sl3">(<a href="../references.html#ref-coyle2022sl3" role="doc-biblioref">Coyle et al. 2022</a>)</span>, which is extensively documented in this <a href="https://tlverse.org/tlverse-handbook/sl3">book chapter</a> <span class="citation" data-cites="phillips2022super vdl2022targeted">(<a href="../references.html#ref-phillips2022super" role="doc-biblioref">Phillips 2022</a>; <a href="../references.html#ref-vdl2022targeted" role="doc-biblioref">van der Laan et al. 2022</a>)</span>.</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="ref-diaz2020nonparametric" class="csl-entry" role="listitem">
Dı́az, Iván, Nima S Hejazi, Kara E Rudolph, and Mark J van der Laan. 2020. <span>“Non-Parametric Efficient Causal Mediation with Intermediate Confounders.”</span> <em>Biometrika</em>. <a href="https://doi.org/10.1093/biomet/asaa085">https://doi.org/10.1093/biomet/asaa085</a>.
</div><div id="ref-klaassen1987consistent" class="csl-entry" role="listitem">
Klaassen, Chris A J. 1987. <span>“Consistent Estimation of the Influence Function of Locally Asymptotically Linear Estimators.”</span> <em>The Annals of Statistics</em>, 1548–62.
</div><div id="ref-zheng2011cross" class="csl-entry" role="listitem">
Zheng, Wenjing, and Mark J van der Laan. 2011. <span>“Cross-Validated Targeted Minimum-Loss-Based Estimation.”</span> In <em>Targeted Learning</em>, 459–74. Springer.
</div><div id="ref-chernozhukov2018double" class="csl-entry" role="listitem">
Chernozhukov, Victor, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and James Robins. 2018. <span>“Double/Debiased Machine Learning for Treatment and Structural Parameters.”</span> <em>The Econometrics Journal</em> 21 (1). <a href="https://doi.org/10.1111/ectj.12097">https://doi.org/10.1111/ectj.12097</a>.
</div><div id="ref-phillips2022super" class="csl-entry" role="listitem">
Phillips, Rachael V. 2022. <span>“Super (Machine) Learning.”</span> In <em><span class="nocase">Targeted Learning in <code>R</code>: Causal Data Science with the <code>tlverse</code> Software Ecosystem</span></em>. Springer. <a href="https://tlverse.org/tlverse-handbook/sl3.html">https://tlverse.org/tlverse-handbook/sl3.html</a>.
</div><div id="ref-vdl2022targeted" class="csl-entry" role="listitem">
van der Laan, Mark J, Jeremy R Coyle, Nima S Hejazi, Ivana Malenica, Rachael V Phillips, and Alan E Hubbard. 2022. <em><span class="nocase">Targeted Learning in <code>R</code>: Causal Data Science with the <code>tlverse</code> Software Ecosystem</span></em>. CRC Press. <a href="https://tlverse.org/tlverse-handbook">https://tlverse.org/tlverse-handbook</a>.
</div></div><section id="interlude-sl3-for-nuisance-parameter-estimation" class="level3 page-columns page-full" data-number="6.2.1"><h3 data-number="6.2.1" class="anchored" data-anchor-id="interlude-sl3-for-nuisance-parameter-estimation">
<span class="header-section-number">6.2.1</span> Interlude: <code>sl3</code> for nuisance parameter estimation</h3>
<ul>
<li><p>To fully take advantage of the one-step and TML estimators, we’d like to rely on flexible, data adaptive strategies for nuisance parameter estimation.</p></li>
<li><p>Doing so minimizes opportunities for model misspecification to compromise our analytic conclusions.</p></li>
<li><p>Choosing among the diversity of available machine learning algorithms can be challenging, so we recommend using the Super Learner algorithm for ensemble machine learning <span class="citation" data-cites="vdl2007super">(<a href="../references.html#ref-vdl2007super" role="doc-biblioref">van der Laan, Polley, and Hubbard 2007</a>)</span>, which is implemented in the <a href="https://github.com/tlverse/sl3"><code>sl3</code> R package</a> <span class="citation" data-cites="coyle2022sl3">(<a href="../references.html#ref-coyle2022sl3" role="doc-biblioref">Coyle et al. 2022</a>)</span>.</p></li>
<li>
<p>Below, we demonstrate the construction of an ensemble learner based on a limited library of algorithms, including n intercept model, a main terms GLM, Lasso (<span class="math inline">\(\ell_1\)</span>-penalized) regression, and random forest (<code>ranger</code>).</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># instantiate learners</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>mean_lrnr <span class="ot">&lt;-</span> Lrnr_mean<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb6-3"><a href="#cb6-3"></a>fglm_lrnr <span class="ot">&lt;-</span> Lrnr_glm_fast<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb6-4"><a href="#cb6-4"></a>lasso_lrnr <span class="ot">&lt;-</span> Lrnr_glmnet<span class="sc">$</span><span class="fu">new</span>(<span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">3</span>)</span>
<span id="cb6-5"><a href="#cb6-5"></a>rf_lrnr <span class="ot">&lt;-</span> Lrnr_ranger<span class="sc">$</span><span class="fu">new</span>(<span class="at">num.trees =</span> <span class="dv">200</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># create learner library and instantiate super learner ensemble</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>lrnr_lib <span class="ot">&lt;-</span> Stack<span class="sc">$</span><span class="fu">new</span>(mean_lrnr, fglm_lrnr, lasso_lrnr, rf_lrnr)</span>
<span id="cb6-9"><a href="#cb6-9"></a>sl_lrnr <span class="ot">&lt;-</span> Lrnr_sl<span class="sc">$</span><span class="fu">new</span>(<span class="at">learners =</span> lrnr_lib, <span class="at">metalearner =</span> Lrnr_nnls<span class="sc">$</span><span class="fu">new</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
<li><p>Of course, there are many alternatives for learning algorithms to be included in such a modeling library. Feel free to explore!</p></li>
</ul><div class="no-row-height column-margin column-container"><div id="ref-vdl2007super" class="csl-entry" role="listitem">
van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. <span>“<span>Super Learner</span>.”</span> <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).
</div><div id="ref-coyle2022sl3" class="csl-entry" role="listitem">
Coyle, Jeremy R, Nima S Hejazi, Ivana Malenica, Rachael V Phillips, and Oleg Sofrygin. 2022. <em><span class="nocase">sl3</span>: Modern Pipelines for Machine Learning and <span>Super Learning</span></em>. <a href="https://github.com/tlverse/sl3" class="uri">https://github.com/tlverse/sl3</a>. <a href="https://doi.org/10.5281/zenodo.1342293">https://doi.org/10.5281/zenodo.1342293</a>.
</div></div></section><section id="efficient-estimation-of-the-natural-indirect-effects" class="level3" data-number="6.2.2"><h3 data-number="6.2.2" class="anchored" data-anchor-id="efficient-estimation-of-the-natural-indirect-effects">
<span class="header-section-number">6.2.2</span> Efficient estimation of the natural (in)direct effects</h3>
<ul>
<li>
<p>Estimation of the natural direct and indirect effects requires estimation of a few nuisance parameters. Recall that these are</p>
<ul>
<li>
<span class="math inline">\(g(a\mid w)\)</span>, which denotes <span class="math inline">\(\P(A=a \mid W=w)\)</span>
</li>
<li>
<span class="math inline">\(h(a\mid m, w)\)</span>, which denotes <span class="math inline">\(\P(A=a \mid M=m, W=w)\)</span>
</li>
<li>
<span class="math inline">\(b(a, m, w)\)</span>, which denotes <span class="math inline">\(\E(Y \mid A=a, M=m, W=w)\)</span>
</li>
</ul>
</li>
<li><p>While we recommend the use of Super Learning, we opt to instead estimate all nuisance parameters with Lasso regression below (to save computational time).</p></li>
<li>
<p>Now, let’s use the <code>medoutcon()</code> function to estimate the <em>natural direct effect</em>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># compute one-step estimate of the natural direct effect</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>nde_onestep <span class="ot">&lt;-</span> <span class="fu">medoutcon</span>(</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="at">W =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"race"</span>, <span class="st">"tvhours"</span>)],</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="at">A =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>sports) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="at">Z =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="at">M =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"snack"</span>, <span class="st">"exercises"</span>, <span class="st">"overweigh"</span>)],</span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="at">Y =</span> weight_behavior<span class="sc">$</span>bmi,</span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="at">g_learners =</span> lasso_lrnr,</span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="at">h_learners =</span> lasso_lrnr,</span>
<span id="cb7-10"><a href="#cb7-10"></a>  <span class="at">b_learners =</span> lasso_lrnr,</span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="at">effect =</span> <span class="st">"direct"</span>,</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="at">estimator =</span> <span class="st">"onestep"</span>,</span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="at">estimator_args =</span> <span class="fu">list</span>(<span class="at">cv_folds =</span> <span class="dv">5</span>)</span>
<span id="cb7-14"><a href="#cb7-14"></a>)</span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="fu">summary</span>(nde_onestep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  lwr_ci param_est upr_ci var_est  eif_mean estimator param         
   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;         
1 -0.388     0.249  0.886   0.106 -6.03e-16 onestep   direct_natural</code></pre>
</div>
</div>
</li>
<li><p>We can similarly call <code>medoutcon()</code> to estimate the <em>natural indirect effect</em>:</p></li>
</ul>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># compute one-step estimate of the natural indirect effect</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>nie_onestep <span class="ot">&lt;-</span> <span class="fu">medoutcon</span>(</span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="at">W =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"race"</span>, <span class="st">"tvhours"</span>)],</span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="at">A =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>sports) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="at">Z =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="at">M =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"snack"</span>, <span class="st">"exercises"</span>, <span class="st">"overweigh"</span>)],</span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="at">Y =</span> weight_behavior<span class="sc">$</span>bmi,</span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="at">g_learners =</span> lasso_lrnr,</span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="at">h_learners =</span> lasso_lrnr,</span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="at">b_learners =</span> lasso_lrnr,</span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="at">effect =</span> <span class="st">"indirect"</span>,</span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="at">estimator =</span> <span class="st">"onestep"</span>,</span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="at">estimator_args =</span> <span class="fu">list</span>(<span class="at">cv_folds =</span> <span class="dv">5</span>)</span>
<span id="cb9-14"><a href="#cb9-14"></a>)</span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="fu">summary</span>(nie_onestep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  lwr_ci param_est upr_ci var_est eif_mean estimator param           
   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;           
1  0.507      1.07   1.63  0.0823 3.10e-15 onestep   indirect_natural</code></pre>
</div>
</div>
<ul>
<li>From the above, we can conclude that the effect of participation on a sports team on BMI is primarily mediated by the variables <code>snack</code>, <code>exercises</code>, and <code>overweigh</code>, as the natural indirect effect is several times larger than the natural direct effect.</li>
<li>Note that we could have instead used the TML estimators, which have improved finite-sample performance, instead of the one-step estimators. Doing this is as simple as setting the <code>estimator = "tmle"</code> in the relevant argument.</li>
</ul></section></section><section id="interventional-indirect-effects" class="level2 page-columns page-full" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="interventional-indirect-effects">
<span class="header-section-number">6.3</span> Interventional (in)direct effects</h2>
<p>Since our knowledge of the system under study is incomplete, we might worry that one (or more) of the measured variables are not mediators, but, in fact, intermediate confounders affected by treatment. While the natural (in)direct effects are not identified in this setting, their interventional (in)direct counterparts are, as we saw in an earlier section. Recall that both types of effects are defined by static interventions on the treatment. The interventional effects are distinguished by their use of a stochastic intervention on the mediator to aid in their identification.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="estimation_walkthrough_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Directed acyclic graph under intermediate confounders of the mediator-outcome relation affected by treatment</figcaption></figure>
</div>
</div>
</div>
<p>Recall that the interventional (in)direct effects are defined via the decomposition:</p>
<p><span class="math display">\[
  \E[Y_{1,G_1} - Y_{0,G_0}] =
    \underbrace{\E[Y_{\color{red}{1},\color{blue}{G_1}} -
    Y_{\color{red}{1},\color{blue}{G_0}}]}_{\text{interventional indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{1},\color{red}{G_0}} -
    Y_{\color{blue}{0},\color{red}{G_0}}]}_{\text{interventional direct effect}}
\]</span></p>
<ul>
<li>In our data example, we’ll consider the eating of snacks as a potential intermediate confounder, since one might reasonably hypothesize that participation on a sports team might subsequently affect snacking, which then could affect mediators like the amount of exercises and overweight status.</li>
<li>The interventional direct and indirect effects may also be easily estimated with the <a href="https://github.com/nhejazi/medoutcon"><code>medoutcon</code> <code>R</code> package</a> <span class="citation" data-cites="hejazi2022medoutcon-rpkg hejazi2022medoutcon-joss">(<a href="../references.html#ref-hejazi2022medoutcon-rpkg" role="doc-biblioref">Hejazi, Dı́az, and Rudolph 2022</a>; <a href="../references.html#ref-hejazi2022medoutcon-joss" role="doc-biblioref">Hejazi, Rudolph, and Dı́az 2022</a>)</span>.</li>
<li>Just as for the natural (in)direct effects, <code>medoutcon</code> implements cross-validated one-step and TML estimators of the interventional effects.</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="ref-hejazi2022medoutcon-rpkg" class="csl-entry" role="listitem">
Hejazi, Nima S, Iván Dı́az, and Kara E Rudolph. 2022. <span>“<span class="nocase">medoutcon</span>: Efficient Natural and Interventional Causal Mediation Analysis.”</span> <a href="https://doi.org/10.5281/zenodo.5809519">https://doi.org/10.5281/zenodo.5809519</a>.
</div><div id="ref-hejazi2022medoutcon-joss" class="csl-entry" role="listitem">
Hejazi, Nima S, Kara E Rudolph, and Iván Dı́az. 2022. <span>“<span class="nocase">medoutcon</span>: Nonparametric Efficient Causal Mediation Analysis with Machine Learning in <span>R</span>.”</span> <em>Journal of Open Source Software</em>. <a href="https://doi.org/10.21105/joss.03979">https://doi.org/10.21105/joss.03979</a>.
</div></div><section id="efficient-estimation-of-the-interventional-indirect-effects" class="level3" data-number="6.3.1"><h3 data-number="6.3.1" class="anchored" data-anchor-id="efficient-estimation-of-the-interventional-indirect-effects">
<span class="header-section-number">6.3.1</span> Efficient estimation of the interventional (in)direct effects</h3>
<ul>
<li>
<p>Estimation of these effects is more complex, so a few additional nuisance parameters arise when expressing the (more general) EIF for these effects:</p>
<ul>
<li>
<span class="math inline">\(q(z \mid a, w)\)</span>, the conditional density of the intermediate confounders, conditional only on treatment and baseline covariates;</li>
<li>
<span class="math inline">\(r(z \mid a, m, w)\)</span>, the conditional density of the intermediate confounders, conditional on mediators, treatment, and baseline covariates.</li>
</ul>
</li>
<li><p>To estimate the interventional effects, we only need to set the argument <code>Z</code> of <code>medoutcon</code> to a value other than <code>NULL</code>.</p></li>
<li><p>Note that the implementation in <code>medoutcon</code> is currently limited to settings with only binary intermediate confounders, i.e., <span class="math inline">\(Z \in \{0, 1\}\)</span>.</p></li>
<li>
<p>Let’s use <code>medoutcon()</code> to estimate the <em>interventional direct effect</em>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># compute one-step estimate of the interventional direct effect</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>interv_de_onestep <span class="ot">&lt;-</span> <span class="fu">medoutcon</span>(</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="at">W =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"race"</span>, <span class="st">"tvhours"</span>)],</span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="at">A =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>sports) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="at">Z =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>snack) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="at">M =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"exercises"</span>, <span class="st">"overweigh"</span>)],</span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="at">Y =</span> weight_behavior<span class="sc">$</span>bmi,</span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="at">g_learners =</span> lasso_lrnr,</span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="at">h_learners =</span> lasso_lrnr,</span>
<span id="cb11-10"><a href="#cb11-10"></a>  <span class="at">b_learners =</span> lasso_lrnr,</span>
<span id="cb11-11"><a href="#cb11-11"></a>  <span class="at">effect =</span> <span class="st">"direct"</span>,</span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="at">estimator =</span> <span class="st">"onestep"</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>  <span class="at">estimator_args =</span> <span class="fu">list</span>(<span class="at">cv_folds =</span> <span class="dv">5</span>)</span>
<span id="cb11-14"><a href="#cb11-14"></a>)</span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="fu">summary</span>(interv_de_onestep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  lwr_ci param_est upr_ci var_est  eif_mean estimator param                
   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                
1 -0.362    0.0921  0.547  0.0538 -4.06e-16 onestep   direct_interventional</code></pre>
</div>
</div>
</li>
<li>
<p>We can similarly estimate the <em>interventional indirect effect</em>:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># compute one-step estimate of the interventional indirect effect</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>interv_ie_onestep <span class="ot">&lt;-</span> <span class="fu">medoutcon</span>(</span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="at">W =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"race"</span>, <span class="st">"tvhours"</span>)],</span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="at">A =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>sports) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="at">Z =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>snack) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="at">M =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"exercises"</span>, <span class="st">"overweigh"</span>)],</span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="at">Y =</span> weight_behavior<span class="sc">$</span>bmi,</span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="at">g_learners =</span> lasso_lrnr,</span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="at">h_learners =</span> lasso_lrnr,</span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="at">b_learners =</span> lasso_lrnr,</span>
<span id="cb13-11"><a href="#cb13-11"></a>  <span class="at">effect =</span> <span class="st">"indirect"</span>,</span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="at">estimator =</span> <span class="st">"onestep"</span>,</span>
<span id="cb13-13"><a href="#cb13-13"></a>  <span class="at">estimator_args =</span> <span class="fu">list</span>(<span class="at">cv_folds =</span> <span class="dv">5</span>)</span>
<span id="cb13-14"><a href="#cb13-14"></a>)</span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="fu">summary</span>(interv_ie_onestep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  lwr_ci param_est upr_ci var_est  eif_mean estimator param                  
   &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;                  
1  0.413     0.992   1.57  0.0872 -1.24e-15 onestep   indirect_interventional</code></pre>
</div>
</div>
</li>
<li><p>From the above, we can conclude that the effect of participation on a sports team on BMI is largely through the interventional indirect effect (i.e., through the pathways involving the mediating variables) rather than via its direct effect.</p></li>
<li><p>Just as before, we could have instead used the TML estimators, instead of the one-step estimators. Doing this is as simple as setting the <code>estimator = "tmle"</code> in the relevant argument.</p></li>
</ul>
<!--
## `medshift`: Stochastic (in)direct effects

While the analyses using the natural and interventional effects have been
illuminating, we may also go beyond the restrictive static interventions
required to define these (in)direct effects. In fact, it may be more realistic
to consider interventions that do not directly force children to join athletic
teams, but instead motivate them to make their participation on such teams more
likely. Importantly, such interventions are often far more realistic and
actionable in real-world studies.

### Formulating the stochastic (in)direct effects

* These more flexible intervention regimes are incompatible with (in)direct
  effect definitions based on decomposing the average treatment effect.
* Instead, consider the decomposition of the population intervention effect
  (PIE) of a _stochastic intervention_ into direct and indirect effects
  [@diaz2020causal]:
\begin{align*}
  \E[Y&_{A_\delta,M_{A_\delta}} - Y_{A,M_A}] = \\
  &\underbrace{\E[Y_{\color{red}{A_\delta},\color{blue}{M_{A_\delta}}} -
    Y_{\color{red}{A_\delta},
    \color{blue}{M}}]}_{\text{stochastic natural indirect effect}} +
    \underbrace{\E[Y_{\color{blue}{A_\delta},\color{red}{M}} -
    Y_{\color{blue}{A},
    \color{red}{M}}]}_{\text{stochastic natural direct effect}}
\end{align*}
* Recall from our discussion of the [incremental propensity score
  interventions](#ipsi) [@kennedy2018nonparametric] that such stochastic
  interventions can compare the pre- and post-intervention odds of exposure:
\begin{equation*}
  \delta = \frac{\text{odds}(A_\delta = 1\mid W=w)}
  {\text{odds}(A = 1\mid W=w)}.
\end{equation*}
* In our analysis, we will modulate the _odds of participating in a sports
  team_ by a fixed amount for each individual, setting, for example,
  $\delta = 2$:

::: {.cell}

```{.r .cell-code}
delta_shift_ipsi <- 2
```
:::

* Such an intervention may be interpreted as the effect of a school program
  that motivates children to participate in sports teams.

### Efficient estimation of the stochastic (in)direct effects

* The decomposition of the PIE into the direct and indirect effects leads to a
  common term $\E[Y_{\color{red}{A_\delta},\color{blue}{M}}]$ involved in both
  the direct and indirect effect definitions. This term may be estimated via
  the [`medshift` `R` package](https://github.com/nhejazi/medshift)
  [@hejazi2020medshift].
* For the direct effect, the remaining term is the
  $\E[Y_{\color{blue}{A},\color{red}{M}}]$, which may be estimated by a simple
  mean in the observed data (i.e., no intervention).
* For the indirect effect, the remaining term is the joint effect of stochastic
  interventions on both $A$ and $M$:
  $\E[Y_{\color{red}{A_\delta},\color{blue}{M_{A_\delta}}}$.
  * For the case of an IPSI on binary $A$, this may be estimated by the tools
    in the [`npcausal` `R` package](https://github.com/ehkennedy/npcausal).
  * For the case of an MTP on continuous $A$, this may be estimated by the
    tools in the [`txshift` `R` package](https://github.com/nhejazi/txshift)
    [@hejazi2020txshift-rpkg; @hejazi2020txshift-joss].
* Like the implementation in `medoutcon`, the `medshift` package makes use of
  cross-validation in constructing initial estimates of nuisance parameters,
  resulting in more robust, cross-validated efficient estimators
  [@klaassen1987consistent; @zheng2011cross; @chernozhukov2018double].
* Now, we're ready to use the `medshift` function to estimate the decomposition
  term common to both the _stochastic direct and indirect effects_:

  ::: {.cell}
  
  ```{.r .cell-code}
  # compute one-step estimate of decomposition term of the (in)direct effects
  stoch_decomp_onestep <- medshift(
    W = weight_behavior[, c("age", "sex", "race", "tvhours")],
    A = (as.numeric(weight_behavior$sports) - 1),
    Z = weight_behavior[, c("snack", "exercises", "overweigh")],
    Y = weight_behavior$bmi,
    delta = delta_shift_ipsi,
    g_learners = lasso_lrnr,
    e_learners = lasso_lrnr,
    m_learners = lasso_lrnr,
    estimator = "onestep",
    estimator_args = list(cv_folds = 5)
  )
  summary(stoch_decomp_onestep)
  ```
  
  ::: {.cell-output .cell-output-stdout}
  
  ```
        lwr_ci    param_est       upr_ci    param_var     eif_mean    estimator 
     18.775219    19.111942    19.448665     0.029515 1.024581e-15      onestep 
  ```
  
  
  :::
  :::


* To estimate the stochastic direct effect, an extra step is necessary -- we
  must apply the delta method:

  ::: {.cell}
  
  ```{.r .cell-code}
  # convenience function to compute inference via delta method: EY1 - EY0
  linear_contrast <- function(params, eifs, ci_level = 0.95) {
    # bounds for confidence interval
    ci_norm_bounds <- c(-1, 1) * abs(stats::qnorm(p = (1 - ci_level) / 2))
    param_est <- params[[1]] - params[[2]]
    eif <- eifs[[1]] - eifs[[2]]
    se_eif <- sqrt(var(eif) / length(eif))
    param_ci <- param_est + ci_norm_bounds * se_eif
    # parameter and inference
    out <- c(param_ci[1], param_est, param_ci[2])
    names(out) <- c("lwr_ci", "param_est", "upr_ci")
    return(out)
  }
  ```
  :::

* Straightforward application of this procedure yields,

  ::: {.cell}
  
  ```{.r .cell-code}
  # parameter estimates and EIFs for components of direct effect
  EY <- mean(weight_behavior$bmi)
  eif_EY <- weight_behavior$bmi - EY
  params_de <- list(stoch_decomp_onestep$theta, EY)
  eifs_de <- list(stoch_decomp_onestep$eif, eif_EY)
  
  # direct effect = EY - estimated quantity
  de_est <- linear_contrast(params_de, eifs_de)
  de_est
  ```
  
  ::: {.cell-output .cell-output-stdout}
  
  ```
       lwr_ci   param_est      upr_ci 
  -0.46792512 -0.01516637  0.43759238 
  ```
  
  
  :::
  :::

* From the above, we can conclude that the effect of increasing the odds of
  participation on a sports team on BMI leads only to a relatively small direct
  effect.
-->

<!-- -->


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/codex\.nimahejazi\.org\/ser2024_mediation_workshop\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/estimation_natural_interv.html" class="pagination-link" aria-label="Construction of G-computation and weighted estimators: The case of the NDE">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Construction of G-computation and weighted estimators: The case of the NDE</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb15" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu"># Some `R` packages for estimation of the causal (in)direct effects</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="in">```{r}</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">#| label: load-renv</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co">#| echo: false</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co">#| message: false</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>renv<span class="sc">::</span><span class="fu">load</span>(here<span class="sc">::</span><span class="fu">here</span>())</span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="fu">library</span>(here)</span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="in">```</span></span>
<span id="cb15-12"><a href="#cb15-12"></a></span>
<span id="cb15-13"><a href="#cb15-13"></a>We'll now turn to working through a few examples of estimating the natural and</span>
<span id="cb15-14"><a href="#cb15-14"></a>interventional direct and indirect effects. Note that we will be using the</span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="co">[</span><span class="ot">`medoutcon` `R` package</span><span class="co">](https://github.com/nhejazi/medoutcon)</span>, which supports</span>
<span id="cb15-16"><a href="#cb15-16"></a>multiple mediators and a single binary intermediate confounder, but, if your</span>
<span id="cb15-17"><a href="#cb15-17"></a>data scenario includes multiple mediators *and* *multiple* intermediate</span>
<span id="cb15-18"><a href="#cb15-18"></a>confounders, you should consider using the [<span class="in">`HDmediation`</span> <span class="in">`R`</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>package](https://github.com/nt-williams/HDmediation) instead.</span>
<span id="cb15-20"><a href="#cb15-20"></a></span>
<span id="cb15-21"><a href="#cb15-21"></a>As our running example, we'll use a simple data set from an observational study of</span>
<span id="cb15-22"><a href="#cb15-22"></a>the relationship between BMI and kids' behavior, freely distributed with the</span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="co">[</span><span class="ot">`mma` `R` package on CRAN</span><span class="co">](https://CRAN.R-project.org/package=mma)</span>. First,</span>
<span id="cb15-24"><a href="#cb15-24"></a>let's load the packages we'll be using and set a seed; then, load this data set</span>
<span id="cb15-25"><a href="#cb15-25"></a>and take a quick look.</span>
<span id="cb15-26"><a href="#cb15-26"></a></span>
<span id="cb15-29"><a href="#cb15-29"></a><span class="in">```{r}</span></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="co">#| label: pkg-setup</span></span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="fu">library</span>(sl3)</span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="fu">library</span>(medoutcon)</span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="fu">library</span>(medshift)</span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="fu">library</span>(mma)</span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="fu">set.seed</span>(<span class="dv">429153</span>)</span>
<span id="cb15-37"><a href="#cb15-37"></a><span class="in">```</span></span>
<span id="cb15-38"><a href="#cb15-38"></a></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="in">```{r}</span></span>
<span id="cb15-42"><a href="#cb15-42"></a><span class="co">#| label: load-data</span></span>
<span id="cb15-43"><a href="#cb15-43"></a><span class="co"># load and examine data</span></span>
<span id="cb15-44"><a href="#cb15-44"></a><span class="fu">data</span>(weight_behavior)</span>
<span id="cb15-45"><a href="#cb15-45"></a><span class="fu">dim</span>(weight_behavior)</span>
<span id="cb15-46"><a href="#cb15-46"></a></span>
<span id="cb15-47"><a href="#cb15-47"></a><span class="co"># drop missing values</span></span>
<span id="cb15-48"><a href="#cb15-48"></a>weight_behavior <span class="ot">&lt;-</span> weight_behavior <span class="sc">%&gt;%</span></span>
<span id="cb15-49"><a href="#cb15-49"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-50"><a href="#cb15-50"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb15-51"><a href="#cb15-51"></a>weight_behavior</span>
<span id="cb15-52"><a href="#cb15-52"></a><span class="in">```</span></span>
<span id="cb15-53"><a href="#cb15-53"></a></span>
<span id="cb15-54"><a href="#cb15-54"></a>The documentation for the data set describes it as a "database obtained from the</span>
<span id="cb15-55"><a href="#cb15-55"></a>Louisiana State University Health Sciences Center, New Orleans, by Dr. Richard</span>
<span id="cb15-56"><a href="#cb15-56"></a>Scribner. He explored the relationship between BMI and kids' behavior through a</span>
<span id="cb15-57"><a href="#cb15-57"></a>survey at children, teachers and parents in Grenada in 2014. This data set</span>
<span id="cb15-58"><a href="#cb15-58"></a>includes 691 observations and 15 variables." Note that the data set contained</span>
<span id="cb15-59"><a href="#cb15-59"></a>several observations with missing values, which we removed above to simplify the</span>
<span id="cb15-60"><a href="#cb15-60"></a>demonstration of our analytic methods. In practice, we recommend instead using</span>
<span id="cb15-61"><a href="#cb15-61"></a>appropriate corrections (e.g., imputation, inverse weighting) to fully take</span>
<span id="cb15-62"><a href="#cb15-62"></a>advantage of the observed data.</span>
<span id="cb15-63"><a href="#cb15-63"></a></span>
<span id="cb15-64"><a href="#cb15-64"></a>Following the motivation of the original study, we focus on the causal effects</span>
<span id="cb15-65"><a href="#cb15-65"></a>of participating in a sports team (<span class="in">`sports`</span>) on the BMI of children (<span class="in">`bmi`</span>),</span>
<span id="cb15-66"><a href="#cb15-66"></a>taking into consideration several mediators (<span class="in">`snack`</span>, <span class="in">`exercises`</span>, <span class="in">`overweigh`</span>);</span>
<span id="cb15-67"><a href="#cb15-67"></a>all other measured covariates are taken to be potential baseline confounders.</span>
<span id="cb15-68"><a href="#cb15-68"></a></span>
<span id="cb15-69"><a href="#cb15-69"></a><span class="fu">## `medoutcon`: Efficient estimation of natural and interventional (in)direct effects</span></span>
<span id="cb15-70"><a href="#cb15-70"></a></span>
<span id="cb15-71"><a href="#cb15-71"></a>The data on a single observational unit can be represented $O = (W, A, M, Y)$,</span>
<span id="cb15-72"><a href="#cb15-72"></a>with the data pooled across all participants denoted $O_1, \ldots, O_n$, for a</span>
<span id="cb15-73"><a href="#cb15-73"></a>of $n$ i.i.d. observations of $O$. Recall the DAG [from an earlier</span>
<span id="cb15-74"><a href="#cb15-74"></a>chapter](#estimands), which represents the data-generating process:</span>
<span id="cb15-75"><a href="#cb15-75"></a></span>
<span id="cb15-78"><a href="#cb15-78"></a><span class="in">```{tikz}</span></span>
<span id="cb15-79"><a href="#cb15-79"></a><span class="in">#| fig-cap: Directed acyclic graph under *no intermediate confounders* of the mediator-outcome relation affected by treatment</span></span>
<span id="cb15-80"><a href="#cb15-80"></a><span class="in">#| echo: false</span></span>
<span id="cb15-81"><a href="#cb15-81"></a><span class="in">\dimendef\prevdepth=0</span></span>
<span id="cb15-82"><a href="#cb15-82"></a><span class="in">\pgfdeclarelayer{background}</span></span>
<span id="cb15-83"><a href="#cb15-83"></a><span class="in">\pgfsetlayers{background,main}</span></span>
<span id="cb15-84"><a href="#cb15-84"></a><span class="in">\usetikzlibrary{arrows,positioning}</span></span>
<span id="cb15-85"><a href="#cb15-85"></a><span class="in">\tikzset{</span></span>
<span id="cb15-86"><a href="#cb15-86"></a><span class="in">&gt;=stealth',</span></span>
<span id="cb15-87"><a href="#cb15-87"></a><span class="in">punkt/.style={</span></span>
<span id="cb15-88"><a href="#cb15-88"></a><span class="in">rectangle,</span></span>
<span id="cb15-89"><a href="#cb15-89"></a><span class="in">rounded corners,</span></span>
<span id="cb15-90"><a href="#cb15-90"></a><span class="in">draw=black, very thick,</span></span>
<span id="cb15-91"><a href="#cb15-91"></a><span class="in">text width=6.5em,</span></span>
<span id="cb15-92"><a href="#cb15-92"></a><span class="in">minimum height=2em,</span></span>
<span id="cb15-93"><a href="#cb15-93"></a><span class="in">text centered},</span></span>
<span id="cb15-94"><a href="#cb15-94"></a><span class="in">pil/.style={</span></span>
<span id="cb15-95"><a href="#cb15-95"></a><span class="in">-&gt;,</span></span>
<span id="cb15-96"><a href="#cb15-96"></a><span class="in">thick,</span></span>
<span id="cb15-97"><a href="#cb15-97"></a><span class="in">shorten &lt;=2pt,</span></span>
<span id="cb15-98"><a href="#cb15-98"></a><span class="in">shorten &gt;=2pt,}</span></span>
<span id="cb15-99"><a href="#cb15-99"></a><span class="in">}</span></span>
<span id="cb15-100"><a href="#cb15-100"></a><span class="in">\newcommand{\Vertex}[2]</span></span>
<span id="cb15-101"><a href="#cb15-101"></a><span class="in">{\node[minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};</span></span>
<span id="cb15-102"><a href="#cb15-102"></a><span class="in">}</span></span>
<span id="cb15-103"><a href="#cb15-103"></a><span class="in">\newcommand{\VertexR}[2]</span></span>
<span id="cb15-104"><a href="#cb15-104"></a><span class="in">{\node[rectangle, draw, minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};</span></span>
<span id="cb15-105"><a href="#cb15-105"></a><span class="in">}</span></span>
<span id="cb15-106"><a href="#cb15-106"></a><span class="in">\newcommand{\ArrowR}[3]</span></span>
<span id="cb15-107"><a href="#cb15-107"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-108"><a href="#cb15-108"></a><span class="in">\draw[-&gt;,#3] (#1) to[bend right=30] (#2);</span></span>
<span id="cb15-109"><a href="#cb15-109"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-110"><a href="#cb15-110"></a><span class="in">}</span></span>
<span id="cb15-111"><a href="#cb15-111"></a><span class="in">\newcommand{\ArrowL}[3]</span></span>
<span id="cb15-112"><a href="#cb15-112"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-113"><a href="#cb15-113"></a><span class="in">\draw[-&gt;,#3] (#1) to[bend left=45] (#2);</span></span>
<span id="cb15-114"><a href="#cb15-114"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-115"><a href="#cb15-115"></a><span class="in">}</span></span>
<span id="cb15-116"><a href="#cb15-116"></a><span class="in">\newcommand{\EdgeL}[3]</span></span>
<span id="cb15-117"><a href="#cb15-117"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-118"><a href="#cb15-118"></a><span class="in">\draw[dashed,#3] (#1) to[bend right=-45] (#2);</span></span>
<span id="cb15-119"><a href="#cb15-119"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-120"><a href="#cb15-120"></a><span class="in">}</span></span>
<span id="cb15-121"><a href="#cb15-121"></a><span class="in">\newcommand{\Arrow}[3]</span></span>
<span id="cb15-122"><a href="#cb15-122"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-123"><a href="#cb15-123"></a><span class="in">\draw[-&gt;,#3] (#1) -- +(#2);</span></span>
<span id="cb15-124"><a href="#cb15-124"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-125"><a href="#cb15-125"></a><span class="in">}</span></span>
<span id="cb15-126"><a href="#cb15-126"></a><span class="in">\begin{tikzpicture}</span></span>
<span id="cb15-127"><a href="#cb15-127"></a><span class="in">  \Vertex{-4, 0}{W}</span></span>
<span id="cb15-128"><a href="#cb15-128"></a><span class="in">  \Vertex{0, 0}{M}</span></span>
<span id="cb15-129"><a href="#cb15-129"></a><span class="in">  \Vertex{-2, 0}{A}</span></span>
<span id="cb15-130"><a href="#cb15-130"></a><span class="in">  \Vertex{2, 0}{Y}</span></span>
<span id="cb15-131"><a href="#cb15-131"></a><span class="in">  \Arrow{W}{A}{black}</span></span>
<span id="cb15-132"><a href="#cb15-132"></a><span class="in">  \Arrow{A}{M}{black}</span></span>
<span id="cb15-133"><a href="#cb15-133"></a><span class="in">  \Arrow{M}{Y}{black}</span></span>
<span id="cb15-134"><a href="#cb15-134"></a><span class="in">  \ArrowL{W}{Y}{black}</span></span>
<span id="cb15-135"><a href="#cb15-135"></a><span class="in">  \ArrowL{A}{Y}{black}</span></span>
<span id="cb15-136"><a href="#cb15-136"></a><span class="in">  \ArrowL{W}{M}{black}</span></span>
<span id="cb15-137"><a href="#cb15-137"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb15-138"><a href="#cb15-138"></a><span class="in">```</span></span>
<span id="cb15-139"><a href="#cb15-139"></a></span>
<span id="cb15-140"><a href="#cb15-140"></a><span class="fu">## Natural (in)direct effects</span></span>
<span id="cb15-141"><a href="#cb15-141"></a></span>
<span id="cb15-142"><a href="#cb15-142"></a>To start, we will consider estimation of the _natural_ direct and indirect effects,</span>
<span id="cb15-143"><a href="#cb15-143"></a>which, we recall, are defined as follows</span>
<span id="cb15-144"><a href="#cb15-144"></a></span>
<span id="cb15-145"><a href="#cb15-145"></a>$$</span>
<span id="cb15-146"><a href="#cb15-146"></a>  \E<span class="co">[</span><span class="ot">Y_{1,M_1} - Y_{0,M_0}</span><span class="co">]</span> =</span>
<span id="cb15-147"><a href="#cb15-147"></a>    \underbrace{\E[Y_{\color{red}{1},\color{blue}{M_1}} -</span>
<span id="cb15-148"><a href="#cb15-148"></a>    Y_{\color{red}{1},\color{blue}{M_0}}]}_{\text{natural indirect effect}} +</span>
<span id="cb15-149"><a href="#cb15-149"></a>    \underbrace{\E[Y_{\color{blue}{1},\color{red}{M_0}} -</span>
<span id="cb15-150"><a href="#cb15-150"></a>    Y_{\color{blue}{0},\color{red}{M_0}}]}_{\text{natural direct effect}}.</span>
<span id="cb15-151"><a href="#cb15-151"></a>$$</span>
<span id="cb15-152"><a href="#cb15-152"></a></span>
<span id="cb15-153"><a href="#cb15-153"></a><span class="ss">* </span>Our <span class="co">[</span><span class="ot">`medoutcon` `R` package</span><span class="co">](https://github.com/nhejazi/medoutcon)</span></span>
<span id="cb15-154"><a href="#cb15-154"></a>  <span class="co">[</span><span class="ot">@hejazi2022medoutcon-rpkg; @hejazi2022medoutcon-joss</span><span class="co">]</span>, which accompanies</span>
<span id="cb15-155"><a href="#cb15-155"></a>  @diaz2020nonparametric, implements one-step and TML estimators of both the</span>
<span id="cb15-156"><a href="#cb15-156"></a>  natural and interventional (in)direct effects.</span>
<span id="cb15-157"><a href="#cb15-157"></a><span class="ss">* </span>Both types of estimators are capable of accommodating flexible modeling</span>
<span id="cb15-158"><a href="#cb15-158"></a>  strategies (e.g., ensemble machine learning) for the initial estimation of</span>
<span id="cb15-159"><a href="#cb15-159"></a>  nuisance parameters.</span>
<span id="cb15-160"><a href="#cb15-160"></a><span class="ss">* </span>The <span class="in">`medoutcon`</span> <span class="in">`R`</span> package uses cross-validation in initial estimation: this</span>
<span id="cb15-161"><a href="#cb15-161"></a>  results in cross-validated (or "cross-fitted") one-step and TML estimators</span>
<span id="cb15-162"><a href="#cb15-162"></a>  <span class="co">[</span><span class="ot">@klaassen1987consistent; @zheng2011cross; @chernozhukov2018double</span><span class="co">]</span>, which</span>
<span id="cb15-163"><a href="#cb15-163"></a>  exhibit greater robustness than their non-sample-splitting analogs.</span>
<span id="cb15-164"><a href="#cb15-164"></a><span class="ss">* </span>To this end, <span class="in">`medoutcon`</span> integrates with the <span class="in">`sl3`</span> <span class="in">`R`</span> package <span class="co">[</span><span class="ot">@coyle2022sl3</span><span class="co">]</span>,</span>
<span id="cb15-165"><a href="#cb15-165"></a>  which is extensively documented in this [book</span>
<span id="cb15-166"><a href="#cb15-166"></a>  chapter](https://tlverse.org/tlverse-handbook/sl3) [@phillips2022super;</span>
<span id="cb15-167"><a href="#cb15-167"></a>  @vdl2022targeted].</span>
<span id="cb15-168"><a href="#cb15-168"></a></span>
<span id="cb15-169"><a href="#cb15-169"></a><span class="fu">### Interlude: `sl3` for nuisance parameter estimation</span></span>
<span id="cb15-170"><a href="#cb15-170"></a></span>
<span id="cb15-171"><a href="#cb15-171"></a><span class="ss">* </span>To fully take advantage of the one-step and TML estimators, we'd like to rely</span>
<span id="cb15-172"><a href="#cb15-172"></a>  on flexible, data adaptive strategies for nuisance parameter estimation.</span>
<span id="cb15-173"><a href="#cb15-173"></a><span class="ss">* </span>Doing so minimizes opportunities for model misspecification to compromise our</span>
<span id="cb15-174"><a href="#cb15-174"></a>  analytic conclusions.</span>
<span id="cb15-175"><a href="#cb15-175"></a><span class="ss">* </span>Choosing among the diversity of available machine learning algorithms can be</span>
<span id="cb15-176"><a href="#cb15-176"></a>  challenging, so we recommend using the Super Learner algorithm for ensemble</span>
<span id="cb15-177"><a href="#cb15-177"></a>  machine learning <span class="co">[</span><span class="ot">@vdl2007super</span><span class="co">]</span>, which is implemented in the [<span class="in">`sl3`</span> R</span>
<span id="cb15-178"><a href="#cb15-178"></a>  package](https://github.com/tlverse/sl3) <span class="co">[</span><span class="ot">@coyle2022sl3</span><span class="co">]</span>.</span>
<span id="cb15-179"><a href="#cb15-179"></a><span class="ss">* </span>Below, we demonstrate the construction of an ensemble learner based on a</span>
<span id="cb15-180"><a href="#cb15-180"></a>  limited library of algorithms, including n intercept model, a main terms GLM,</span>
<span id="cb15-181"><a href="#cb15-181"></a>  Lasso ($\ell_1$-penalized) regression, and random forest (<span class="in">`ranger`</span>).</span>
<span id="cb15-182"><a href="#cb15-182"></a>  <span class="in">```{r}</span></span>
<span id="cb15-183"><a href="#cb15-183"></a><span class="in">  #| label: setup-sl</span></span>
<span id="cb15-184"><a href="#cb15-184"></a><span class="in">  # instantiate learners</span></span>
<span id="cb15-185"><a href="#cb15-185"></a><span class="in">  mean_lrnr &lt;- Lrnr_mean$new()</span></span>
<span id="cb15-186"><a href="#cb15-186"></a><span class="in">  fglm_lrnr &lt;- Lrnr_glm_fast$new()</span></span>
<span id="cb15-187"><a href="#cb15-187"></a><span class="in">  lasso_lrnr &lt;- Lrnr_glmnet$new(alpha = 1, nfolds = 3)</span></span>
<span id="cb15-188"><a href="#cb15-188"></a><span class="in">  rf_lrnr &lt;- Lrnr_ranger$new(num.trees = 200)</span></span>
<span id="cb15-189"><a href="#cb15-189"></a></span>
<span id="cb15-190"><a href="#cb15-190"></a><span class="in">  # create learner library and instantiate super learner ensemble</span></span>
<span id="cb15-191"><a href="#cb15-191"></a><span class="in">  lrnr_lib &lt;- Stack$new(mean_lrnr, fglm_lrnr, lasso_lrnr, rf_lrnr)</span></span>
<span id="cb15-192"><a href="#cb15-192"></a><span class="in">  sl_lrnr &lt;- Lrnr_sl$new(learners = lrnr_lib, metalearner = Lrnr_nnls$new())</span></span>
<span id="cb15-193"><a href="#cb15-193"></a><span class="in">  ```</span></span>
<span id="cb15-194"><a href="#cb15-194"></a></span>
<span id="cb15-195"><a href="#cb15-195"></a><span class="ss">* </span>Of course, there are many alternatives for learning algorithms to be included</span>
<span id="cb15-196"><a href="#cb15-196"></a>  in such a modeling library. Feel free to explore!</span>
<span id="cb15-197"><a href="#cb15-197"></a></span>
<span id="cb15-198"><a href="#cb15-198"></a><span class="fu">### Efficient estimation of the natural (in)direct effects</span></span>
<span id="cb15-199"><a href="#cb15-199"></a></span>
<span id="cb15-200"><a href="#cb15-200"></a><span class="ss">* </span>Estimation of the natural direct and indirect effects requires estimation of a</span>
<span id="cb15-201"><a href="#cb15-201"></a>  few nuisance parameters. Recall that these are</span>
<span id="cb15-202"><a href="#cb15-202"></a><span class="ss">  - </span>$g(a\mid w)$, which denotes $\P(A=a \mid W=w)$</span>
<span id="cb15-203"><a href="#cb15-203"></a><span class="ss">  - </span>$h(a\mid m, w)$, which denotes $\P(A=a \mid M=m, W=w)$</span>
<span id="cb15-204"><a href="#cb15-204"></a><span class="ss">  - </span>$b(a, m, w)$, which denotes $\E(Y \mid A=a, M=m, W=w)$</span>
<span id="cb15-205"><a href="#cb15-205"></a><span class="ss">* </span>While we recommend the use of Super Learning, we opt to instead estimate all</span>
<span id="cb15-206"><a href="#cb15-206"></a>  nuisance parameters with Lasso regression below (to save computational time).</span>
<span id="cb15-207"><a href="#cb15-207"></a><span class="ss">* </span>Now, let's use the <span class="in">`medoutcon()`</span> function to estimate the _natural direct</span>
<span id="cb15-208"><a href="#cb15-208"></a>  effect_:</span>
<span id="cb15-209"><a href="#cb15-209"></a>  <span class="in">```{r}</span></span>
<span id="cb15-210"><a href="#cb15-210"></a><span class="in">  #| label: natural-de-os</span></span>
<span id="cb15-211"><a href="#cb15-211"></a><span class="in">  # compute one-step estimate of the natural direct effect</span></span>
<span id="cb15-212"><a href="#cb15-212"></a><span class="in">  nde_onestep &lt;- medoutcon(</span></span>
<span id="cb15-213"><a href="#cb15-213"></a><span class="in">    W = weight_behavior[, c("age", "sex", "race", "tvhours")],</span></span>
<span id="cb15-214"><a href="#cb15-214"></a><span class="in">    A = (as.numeric(weight_behavior$sports) - 1),</span></span>
<span id="cb15-215"><a href="#cb15-215"></a><span class="in">    Z = NULL,</span></span>
<span id="cb15-216"><a href="#cb15-216"></a><span class="in">    M = weight_behavior[, c("snack", "exercises", "overweigh")],</span></span>
<span id="cb15-217"><a href="#cb15-217"></a><span class="in">    Y = weight_behavior$bmi,</span></span>
<span id="cb15-218"><a href="#cb15-218"></a><span class="in">    g_learners = lasso_lrnr,</span></span>
<span id="cb15-219"><a href="#cb15-219"></a><span class="in">    h_learners = lasso_lrnr,</span></span>
<span id="cb15-220"><a href="#cb15-220"></a><span class="in">    b_learners = lasso_lrnr,</span></span>
<span id="cb15-221"><a href="#cb15-221"></a><span class="in">    effect = "direct",</span></span>
<span id="cb15-222"><a href="#cb15-222"></a><span class="in">    estimator = "onestep",</span></span>
<span id="cb15-223"><a href="#cb15-223"></a><span class="in">    estimator_args = list(cv_folds = 5)</span></span>
<span id="cb15-224"><a href="#cb15-224"></a><span class="in">  )</span></span>
<span id="cb15-225"><a href="#cb15-225"></a><span class="in">  summary(nde_onestep)</span></span>
<span id="cb15-226"><a href="#cb15-226"></a><span class="in">  ```</span></span>
<span id="cb15-227"><a href="#cb15-227"></a></span>
<span id="cb15-228"><a href="#cb15-228"></a><span class="ss">* </span>We can similarly call <span class="in">`medoutcon()`</span> to estimate the _natural indirect effect_:</span>
<span id="cb15-229"><a href="#cb15-229"></a></span>
<span id="cb15-232"><a href="#cb15-232"></a><span class="in">```{r}</span></span>
<span id="cb15-233"><a href="#cb15-233"></a><span class="co">#| label: natural-ie-os</span></span>
<span id="cb15-234"><a href="#cb15-234"></a><span class="co"># compute one-step estimate of the natural indirect effect</span></span>
<span id="cb15-235"><a href="#cb15-235"></a>nie_onestep <span class="ot">&lt;-</span> <span class="fu">medoutcon</span>(</span>
<span id="cb15-236"><a href="#cb15-236"></a>  <span class="at">W =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"race"</span>, <span class="st">"tvhours"</span>)],</span>
<span id="cb15-237"><a href="#cb15-237"></a>  <span class="at">A =</span> (<span class="fu">as.numeric</span>(weight_behavior<span class="sc">$</span>sports) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb15-238"><a href="#cb15-238"></a>  <span class="at">Z =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-239"><a href="#cb15-239"></a>  <span class="at">M =</span> weight_behavior[, <span class="fu">c</span>(<span class="st">"snack"</span>, <span class="st">"exercises"</span>, <span class="st">"overweigh"</span>)],</span>
<span id="cb15-240"><a href="#cb15-240"></a>  <span class="at">Y =</span> weight_behavior<span class="sc">$</span>bmi,</span>
<span id="cb15-241"><a href="#cb15-241"></a>  <span class="at">g_learners =</span> lasso_lrnr,</span>
<span id="cb15-242"><a href="#cb15-242"></a>  <span class="at">h_learners =</span> lasso_lrnr,</span>
<span id="cb15-243"><a href="#cb15-243"></a>  <span class="at">b_learners =</span> lasso_lrnr,</span>
<span id="cb15-244"><a href="#cb15-244"></a>  <span class="at">effect =</span> <span class="st">"indirect"</span>,</span>
<span id="cb15-245"><a href="#cb15-245"></a>  <span class="at">estimator =</span> <span class="st">"onestep"</span>,</span>
<span id="cb15-246"><a href="#cb15-246"></a>  <span class="at">estimator_args =</span> <span class="fu">list</span>(<span class="at">cv_folds =</span> <span class="dv">5</span>)</span>
<span id="cb15-247"><a href="#cb15-247"></a>)</span>
<span id="cb15-248"><a href="#cb15-248"></a><span class="fu">summary</span>(nie_onestep)</span>
<span id="cb15-249"><a href="#cb15-249"></a><span class="in">```</span></span>
<span id="cb15-250"><a href="#cb15-250"></a></span>
<span id="cb15-251"><a href="#cb15-251"></a><span class="ss">* </span>From the above, we can conclude that the effect of participation on a sports</span>
<span id="cb15-252"><a href="#cb15-252"></a>  team on BMI is primarily mediated by the variables <span class="in">`snack`</span>, <span class="in">`exercises`</span>, and</span>
<span id="cb15-253"><a href="#cb15-253"></a>  <span class="in">`overweigh`</span>, as the natural indirect effect is several times larger than the</span>
<span id="cb15-254"><a href="#cb15-254"></a>  natural direct effect.</span>
<span id="cb15-255"><a href="#cb15-255"></a><span class="ss">* </span>Note that we could have instead used the TML estimators, which have improved</span>
<span id="cb15-256"><a href="#cb15-256"></a>  finite-sample performance, instead of the one-step estimators. Doing this is</span>
<span id="cb15-257"><a href="#cb15-257"></a>  as simple as setting the <span class="in">`estimator = "tmle"`</span> in the relevant argument.</span>
<span id="cb15-258"><a href="#cb15-258"></a></span>
<span id="cb15-259"><a href="#cb15-259"></a><span class="fu">## Interventional (in)direct effects</span></span>
<span id="cb15-260"><a href="#cb15-260"></a></span>
<span id="cb15-261"><a href="#cb15-261"></a>Since our knowledge of the system under study is incomplete, we might worry that</span>
<span id="cb15-262"><a href="#cb15-262"></a>one (or more) of the measured variables are not mediators, but, in fact,</span>
<span id="cb15-263"><a href="#cb15-263"></a>intermediate confounders affected by treatment. While the natural (in)direct</span>
<span id="cb15-264"><a href="#cb15-264"></a>effects are not identified in this setting, their interventional (in)direct</span>
<span id="cb15-265"><a href="#cb15-265"></a>counterparts are, as we saw in an earlier section. Recall that both types of</span>
<span id="cb15-266"><a href="#cb15-266"></a>effects are defined by static interventions on the treatment. The interventional</span>
<span id="cb15-267"><a href="#cb15-267"></a>effects are distinguished by their use of a stochastic intervention on the</span>
<span id="cb15-268"><a href="#cb15-268"></a>mediator to aid in their identification.</span>
<span id="cb15-269"><a href="#cb15-269"></a></span>
<span id="cb15-272"><a href="#cb15-272"></a><span class="in">```{tikz}</span></span>
<span id="cb15-273"><a href="#cb15-273"></a><span class="in">#| fig-cap: Directed acyclic graph under intermediate confounders of the mediator-outcome relation affected by treatment</span></span>
<span id="cb15-274"><a href="#cb15-274"></a><span class="in">#| echo: false</span></span>
<span id="cb15-275"><a href="#cb15-275"></a><span class="in">\dimendef\prevdepth=0</span></span>
<span id="cb15-276"><a href="#cb15-276"></a><span class="in">\pgfdeclarelayer{background}</span></span>
<span id="cb15-277"><a href="#cb15-277"></a><span class="in">\pgfsetlayers{background,main}</span></span>
<span id="cb15-278"><a href="#cb15-278"></a><span class="in">\usetikzlibrary{arrows,positioning}</span></span>
<span id="cb15-279"><a href="#cb15-279"></a><span class="in">\tikzset{</span></span>
<span id="cb15-280"><a href="#cb15-280"></a><span class="in">&gt;=stealth',</span></span>
<span id="cb15-281"><a href="#cb15-281"></a><span class="in">punkt/.style={</span></span>
<span id="cb15-282"><a href="#cb15-282"></a><span class="in">rectangle,</span></span>
<span id="cb15-283"><a href="#cb15-283"></a><span class="in">rounded corners,</span></span>
<span id="cb15-284"><a href="#cb15-284"></a><span class="in">draw=black, very thick,</span></span>
<span id="cb15-285"><a href="#cb15-285"></a><span class="in">text width=6.5em,</span></span>
<span id="cb15-286"><a href="#cb15-286"></a><span class="in">minimum height=2em,</span></span>
<span id="cb15-287"><a href="#cb15-287"></a><span class="in">text centered},</span></span>
<span id="cb15-288"><a href="#cb15-288"></a><span class="in">pil/.style={</span></span>
<span id="cb15-289"><a href="#cb15-289"></a><span class="in">-&gt;,</span></span>
<span id="cb15-290"><a href="#cb15-290"></a><span class="in">thick,</span></span>
<span id="cb15-291"><a href="#cb15-291"></a><span class="in">shorten &lt;=2pt,</span></span>
<span id="cb15-292"><a href="#cb15-292"></a><span class="in">shorten &gt;=2pt,}</span></span>
<span id="cb15-293"><a href="#cb15-293"></a><span class="in">}</span></span>
<span id="cb15-294"><a href="#cb15-294"></a><span class="in">\newcommand{\Vertex}[2]</span></span>
<span id="cb15-295"><a href="#cb15-295"></a><span class="in">{\node[minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};</span></span>
<span id="cb15-296"><a href="#cb15-296"></a><span class="in">}</span></span>
<span id="cb15-297"><a href="#cb15-297"></a><span class="in">\newcommand{\VertexR}[2]</span></span>
<span id="cb15-298"><a href="#cb15-298"></a><span class="in">{\node[rectangle, draw, minimum width=0.6cm,inner sep=0.05cm] (#2) at (#1) {$#2$};</span></span>
<span id="cb15-299"><a href="#cb15-299"></a><span class="in">}</span></span>
<span id="cb15-300"><a href="#cb15-300"></a><span class="in">\newcommand{\ArrowR}[3]</span></span>
<span id="cb15-301"><a href="#cb15-301"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-302"><a href="#cb15-302"></a><span class="in">\draw[-&gt;,#3] (#1) to[bend right=30] (#2);</span></span>
<span id="cb15-303"><a href="#cb15-303"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-304"><a href="#cb15-304"></a><span class="in">}</span></span>
<span id="cb15-305"><a href="#cb15-305"></a><span class="in">\newcommand{\ArrowL}[3]</span></span>
<span id="cb15-306"><a href="#cb15-306"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-307"><a href="#cb15-307"></a><span class="in">\draw[-&gt;,#3] (#1) to[bend left=45] (#2);</span></span>
<span id="cb15-308"><a href="#cb15-308"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-309"><a href="#cb15-309"></a><span class="in">}</span></span>
<span id="cb15-310"><a href="#cb15-310"></a><span class="in">\newcommand{\EdgeL}[3]</span></span>
<span id="cb15-311"><a href="#cb15-311"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-312"><a href="#cb15-312"></a><span class="in">\draw[dashed,#3] (#1) to[bend right=-45] (#2);</span></span>
<span id="cb15-313"><a href="#cb15-313"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-314"><a href="#cb15-314"></a><span class="in">}</span></span>
<span id="cb15-315"><a href="#cb15-315"></a><span class="in">\newcommand{\Arrow}[3]</span></span>
<span id="cb15-316"><a href="#cb15-316"></a><span class="in">{ \begin{pgfonlayer}{background}</span></span>
<span id="cb15-317"><a href="#cb15-317"></a><span class="in">\draw[-&gt;,#3] (#1) -- +(#2);</span></span>
<span id="cb15-318"><a href="#cb15-318"></a><span class="in">\end{pgfonlayer}</span></span>
<span id="cb15-319"><a href="#cb15-319"></a><span class="in">}</span></span>
<span id="cb15-320"><a href="#cb15-320"></a><span class="in">\begin{tikzpicture}</span></span>
<span id="cb15-321"><a href="#cb15-321"></a><span class="in">  \Vertex{0, -1}{Z}</span></span>
<span id="cb15-322"><a href="#cb15-322"></a><span class="in">  \Vertex{-4, 0}{W}</span></span>
<span id="cb15-323"><a href="#cb15-323"></a><span class="in">  \Vertex{0, 0}{M}</span></span>
<span id="cb15-324"><a href="#cb15-324"></a><span class="in">  \Vertex{-2, 0}{A}</span></span>
<span id="cb15-325"><a href="#cb15-325"></a><span class="in">  \Vertex{2, 0}{Y}</span></span>
<span id="cb15-326"><a href="#cb15-326"></a><span class="in">  \ArrowR{W}{Z}{black}</span></span>
<span id="cb15-327"><a href="#cb15-327"></a><span class="in">  \Arrow{Z}{M}{black}</span></span>
<span id="cb15-328"><a href="#cb15-328"></a><span class="in">  \Arrow{W}{A}{black}</span></span>
<span id="cb15-329"><a href="#cb15-329"></a><span class="in">  \Arrow{A}{M}{black}</span></span>
<span id="cb15-330"><a href="#cb15-330"></a><span class="in">  \Arrow{M}{Y}{black}</span></span>
<span id="cb15-331"><a href="#cb15-331"></a><span class="in">  \Arrow{A}{Z}{black}</span></span>
<span id="cb15-332"><a href="#cb15-332"></a><span class="in">  \Arrow{Z}{Y}{black}</span></span>
<span id="cb15-333"><a href="#cb15-333"></a><span class="in">  \ArrowL{W}{Y}{black}</span></span>
<span id="cb15-334"><a href="#cb15-334"></a><span class="in">  \ArrowL{A}{Y}{black}</span></span>
<span id="cb15-335"><a href="#cb15-335"></a><span class="in">  \ArrowL{W}{M}{black}</span></span>
<span id="cb15-336"><a href="#cb15-336"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb15-337"><a href="#cb15-337"></a><span class="in">```</span></span>
<span id="cb15-338"><a href="#cb15-338"></a></span>
<span id="cb15-339"><a href="#cb15-339"></a>Recall that the interventional (in)direct effects are defined via the</span>
<span id="cb15-340"><a href="#cb15-340"></a>decomposition:</span>
<span id="cb15-341"><a href="#cb15-341"></a></span>
<span id="cb15-342"><a href="#cb15-342"></a>$$</span>
<span id="cb15-343"><a href="#cb15-343"></a>  \E<span class="co">[</span><span class="ot">Y_{1,G_1} - Y_{0,G_0}</span><span class="co">]</span> =</span>
<span id="cb15-344"><a href="#cb15-344"></a>    \underbrace{\E[Y_{\color{red}{1},\color{blue}{G_1}} -</span>
<span id="cb15-345"><a href="#cb15-345"></a>    Y_{\color{red}{1},\color{blue}{G_0}}]}_{\text{interventional indirect effect}} +</span>
<span id="cb15-346"><a href="#cb15-346"></a>    \underbrace{\E[Y_{\color{blue}{1},\color{red}{G_0}} -</span>
<span id="cb15-347"><a href="#cb15-347"></a>    Y_{\color{blue}{0},\color{red}{G_0}}]}_{\text{interventional direct effect}}</span>
<span id="cb15-348"><a href="#cb15-348"></a>$$</span>
<span id="cb15-349"><a href="#cb15-349"></a></span>
<span id="cb15-350"><a href="#cb15-350"></a><span class="ss">* </span>In our data example, we'll consider the eating of snacks as a potential</span>
<span id="cb15-351"><a href="#cb15-351"></a>  intermediate confounder, since one might reasonably hypothesize that</span>
<span id="cb15-352"><a href="#cb15-352"></a>  participation on a sports team might subsequently affect snacking, which then</span>
<span id="cb15-353"><a href="#cb15-353"></a>  could affect mediators like the amount of exercises and overweight status.</span>
<span id="cb15-354"><a href="#cb15-354"></a><span class="ss">* </span>The interventional direct and indirect effects may also be easily estimated</span>
<span id="cb15-355"><a href="#cb15-355"></a>  with the <span class="co">[</span><span class="ot">`medoutcon` `R` package</span><span class="co">](https://github.com/nhejazi/medoutcon)</span></span>
<span id="cb15-356"><a href="#cb15-356"></a>  <span class="co">[</span><span class="ot">@hejazi2022medoutcon-rpkg; @hejazi2022medoutcon-joss</span><span class="co">]</span>.</span>
<span id="cb15-357"><a href="#cb15-357"></a><span class="ss">* </span>Just as for the natural (in)direct effects, <span class="in">`medoutcon`</span> implements</span>
<span id="cb15-358"><a href="#cb15-358"></a>  cross-validated one-step and TML estimators of the interventional effects.</span>
<span id="cb15-359"><a href="#cb15-359"></a></span>
<span id="cb15-360"><a href="#cb15-360"></a><span class="fu">### Efficient estimation of the interventional (in)direct effects</span></span>
<span id="cb15-361"><a href="#cb15-361"></a></span>
<span id="cb15-362"><a href="#cb15-362"></a><span class="ss">* </span>Estimation of these effects is more complex, so a few additional nuisance</span>
<span id="cb15-363"><a href="#cb15-363"></a>  parameters arise when expressing the (more general) EIF for these effects:</span>
<span id="cb15-364"><a href="#cb15-364"></a><span class="ss">  * </span>$q(z \mid a, w)$, the conditional density of the intermediate confounders,</span>
<span id="cb15-365"><a href="#cb15-365"></a>    conditional only on treatment and baseline covariates;</span>
<span id="cb15-366"><a href="#cb15-366"></a><span class="ss">  * </span>$r(z \mid a, m, w)$, the conditional density of the intermediate</span>
<span id="cb15-367"><a href="#cb15-367"></a>    confounders, conditional on mediators, treatment, and baseline covariates.</span>
<span id="cb15-368"><a href="#cb15-368"></a><span class="ss">* </span>To estimate the interventional effects, we only need to set the argument <span class="in">`Z`</span></span>
<span id="cb15-369"><a href="#cb15-369"></a>  of <span class="in">`medoutcon`</span> to a value other than <span class="in">`NULL`</span>.</span>
<span id="cb15-370"><a href="#cb15-370"></a><span class="ss">* </span>Note that the implementation in <span class="in">`medoutcon`</span> is currently limited to settings</span>
<span id="cb15-371"><a href="#cb15-371"></a>  with only binary intermediate confounders, i.e., $Z \in <span class="sc">\{</span>0, 1<span class="sc">\}</span>$.</span>
<span id="cb15-372"><a href="#cb15-372"></a><span class="ss">* </span>Let's use <span class="in">`medoutcon()`</span> to estimate the _interventional direct effect_:</span>
<span id="cb15-373"><a href="#cb15-373"></a>  <span class="in">```{r}</span></span>
<span id="cb15-374"><a href="#cb15-374"></a><span class="in">  #| label: interv-de-os</span></span>
<span id="cb15-375"><a href="#cb15-375"></a><span class="in">  # compute one-step estimate of the interventional direct effect</span></span>
<span id="cb15-376"><a href="#cb15-376"></a><span class="in">  interv_de_onestep &lt;- medoutcon(</span></span>
<span id="cb15-377"><a href="#cb15-377"></a><span class="in">    W = weight_behavior[, c("age", "sex", "race", "tvhours")],</span></span>
<span id="cb15-378"><a href="#cb15-378"></a><span class="in">    A = (as.numeric(weight_behavior$sports) - 1),</span></span>
<span id="cb15-379"><a href="#cb15-379"></a><span class="in">    Z = (as.numeric(weight_behavior$snack) - 1),</span></span>
<span id="cb15-380"><a href="#cb15-380"></a><span class="in">    M = weight_behavior[, c("exercises", "overweigh")],</span></span>
<span id="cb15-381"><a href="#cb15-381"></a><span class="in">    Y = weight_behavior$bmi,</span></span>
<span id="cb15-382"><a href="#cb15-382"></a><span class="in">    g_learners = lasso_lrnr,</span></span>
<span id="cb15-383"><a href="#cb15-383"></a><span class="in">    h_learners = lasso_lrnr,</span></span>
<span id="cb15-384"><a href="#cb15-384"></a><span class="in">    b_learners = lasso_lrnr,</span></span>
<span id="cb15-385"><a href="#cb15-385"></a><span class="in">    effect = "direct",</span></span>
<span id="cb15-386"><a href="#cb15-386"></a><span class="in">    estimator = "onestep",</span></span>
<span id="cb15-387"><a href="#cb15-387"></a><span class="in">    estimator_args = list(cv_folds = 5)</span></span>
<span id="cb15-388"><a href="#cb15-388"></a><span class="in">  )</span></span>
<span id="cb15-389"><a href="#cb15-389"></a><span class="in">  summary(interv_de_onestep)</span></span>
<span id="cb15-390"><a href="#cb15-390"></a><span class="in">  ```</span></span>
<span id="cb15-391"><a href="#cb15-391"></a></span>
<span id="cb15-392"><a href="#cb15-392"></a><span class="ss">* </span>We can similarly estimate the _interventional indirect effect_:</span>
<span id="cb15-393"><a href="#cb15-393"></a>  <span class="in">```{r}</span></span>
<span id="cb15-394"><a href="#cb15-394"></a><span class="in">  #| label: interv-ie-os</span></span>
<span id="cb15-395"><a href="#cb15-395"></a><span class="in">  # compute one-step estimate of the interventional indirect effect</span></span>
<span id="cb15-396"><a href="#cb15-396"></a><span class="in">  interv_ie_onestep &lt;- medoutcon(</span></span>
<span id="cb15-397"><a href="#cb15-397"></a><span class="in">    W = weight_behavior[, c("age", "sex", "race", "tvhours")],</span></span>
<span id="cb15-398"><a href="#cb15-398"></a><span class="in">    A = (as.numeric(weight_behavior$sports) - 1),</span></span>
<span id="cb15-399"><a href="#cb15-399"></a><span class="in">    Z = (as.numeric(weight_behavior$snack) - 1),</span></span>
<span id="cb15-400"><a href="#cb15-400"></a><span class="in">    M = weight_behavior[, c("exercises", "overweigh")],</span></span>
<span id="cb15-401"><a href="#cb15-401"></a><span class="in">    Y = weight_behavior$bmi,</span></span>
<span id="cb15-402"><a href="#cb15-402"></a><span class="in">    g_learners = lasso_lrnr,</span></span>
<span id="cb15-403"><a href="#cb15-403"></a><span class="in">    h_learners = lasso_lrnr,</span></span>
<span id="cb15-404"><a href="#cb15-404"></a><span class="in">    b_learners = lasso_lrnr,</span></span>
<span id="cb15-405"><a href="#cb15-405"></a><span class="in">    effect = "indirect",</span></span>
<span id="cb15-406"><a href="#cb15-406"></a><span class="in">    estimator = "onestep",</span></span>
<span id="cb15-407"><a href="#cb15-407"></a><span class="in">    estimator_args = list(cv_folds = 5)</span></span>
<span id="cb15-408"><a href="#cb15-408"></a><span class="in">  )</span></span>
<span id="cb15-409"><a href="#cb15-409"></a><span class="in">  summary(interv_ie_onestep)</span></span>
<span id="cb15-410"><a href="#cb15-410"></a><span class="in">  ```</span></span>
<span id="cb15-411"><a href="#cb15-411"></a></span>
<span id="cb15-412"><a href="#cb15-412"></a><span class="ss">* </span>From the above, we can conclude that the effect of participation on a sports</span>
<span id="cb15-413"><a href="#cb15-413"></a>  team on BMI is largely through the interventional indirect effect (i.e.,</span>
<span id="cb15-414"><a href="#cb15-414"></a>  through the pathways involving the mediating variables) rather than via its</span>
<span id="cb15-415"><a href="#cb15-415"></a>  direct effect.</span>
<span id="cb15-416"><a href="#cb15-416"></a><span class="ss">* </span>Just as before, we could have instead used the TML estimators, instead of the</span>
<span id="cb15-417"><a href="#cb15-417"></a>  one-step estimators. Doing this is as simple as setting the</span>
<span id="cb15-418"><a href="#cb15-418"></a>  <span class="in">`estimator = "tmle"`</span> in the relevant argument.</span>
<span id="cb15-419"><a href="#cb15-419"></a></span>
<span id="cb15-420"><a href="#cb15-420"></a><span class="co">&lt;!--</span></span>
<span id="cb15-421"><a href="#cb15-421"></a><span class="co">## `medshift`: Stochastic (in)direct effects</span></span>
<span id="cb15-422"><a href="#cb15-422"></a></span>
<span id="cb15-423"><a href="#cb15-423"></a><span class="co">While the analyses using the natural and interventional effects have been</span></span>
<span id="cb15-424"><a href="#cb15-424"></a><span class="co">illuminating, we may also go beyond the restrictive static interventions</span></span>
<span id="cb15-425"><a href="#cb15-425"></a><span class="co">required to define these (in)direct effects. In fact, it may be more realistic</span></span>
<span id="cb15-426"><a href="#cb15-426"></a><span class="co">to consider interventions that do not directly force children to join athletic</span></span>
<span id="cb15-427"><a href="#cb15-427"></a><span class="co">teams, but instead motivate them to make their participation on such teams more</span></span>
<span id="cb15-428"><a href="#cb15-428"></a><span class="co">likely. Importantly, such interventions are often far more realistic and</span></span>
<span id="cb15-429"><a href="#cb15-429"></a><span class="co">actionable in real-world studies.</span></span>
<span id="cb15-430"><a href="#cb15-430"></a></span>
<span id="cb15-431"><a href="#cb15-431"></a><span class="al">###</span><span class="co"> Formulating the stochastic (in)direct effects</span></span>
<span id="cb15-432"><a href="#cb15-432"></a></span>
<span id="cb15-433"><a href="#cb15-433"></a><span class="co">* These more flexible intervention regimes are incompatible with (in)direct</span></span>
<span id="cb15-434"><a href="#cb15-434"></a><span class="co">  effect definitions based on decomposing the average treatment effect.</span></span>
<span id="cb15-435"><a href="#cb15-435"></a><span class="co">* Instead, consider the decomposition of the population intervention effect</span></span>
<span id="cb15-436"><a href="#cb15-436"></a><span class="co">  (PIE) of a _stochastic intervention_ into direct and indirect effects</span></span>
<span id="cb15-437"><a href="#cb15-437"></a><span class="co">  [@diaz2020causal]:</span></span>
<span id="cb15-438"><a href="#cb15-438"></a><span class="co">\begin{align*}</span></span>
<span id="cb15-439"><a href="#cb15-439"></a><span class="co">  \E[Y&amp;_{A_\delta,M_{A_\delta}} - Y_{A,M_A}] = \\</span></span>
<span id="cb15-440"><a href="#cb15-440"></a><span class="co">  &amp;\underbrace{\E[Y_{\color{red}{A_\delta},\color{blue}{M_{A_\delta</span><span class="re">}}}</span><span class="co"> -</span></span>
<span id="cb15-441"><a href="#cb15-441"></a><span class="co">    Y_{\color{red}{A_\delta},</span></span>
<span id="cb15-442"><a href="#cb15-442"></a><span class="co">    \color{blue}{M}}]}_{\text{stochastic natural indirect effect}} +</span></span>
<span id="cb15-443"><a href="#cb15-443"></a><span class="co">    \underbrace{\E[Y_{\color{blue}{A_\delta},\color{red}{M}} -</span></span>
<span id="cb15-444"><a href="#cb15-444"></a><span class="co">    Y_{\color{blue}{A},</span></span>
<span id="cb15-445"><a href="#cb15-445"></a><span class="co">    \color{red}{M}}]}_{\text{stochastic natural direct effect}}</span></span>
<span id="cb15-446"><a href="#cb15-446"></a><span class="co">\end{align*}</span></span>
<span id="cb15-447"><a href="#cb15-447"></a><span class="co">* Recall from our discussion of the [incremental propensity score</span></span>
<span id="cb15-448"><a href="#cb15-448"></a><span class="co">  interventions](#ipsi) [@kennedy2018nonparametric] that such stochastic</span></span>
<span id="cb15-449"><a href="#cb15-449"></a><span class="co">  interventions can compare the pre- and post-intervention odds of exposure:</span></span>
<span id="cb15-450"><a href="#cb15-450"></a><span class="co">\begin{equation*}</span></span>
<span id="cb15-451"><a href="#cb15-451"></a><span class="co">  \delta = \frac{\text{odds}(A_\delta = 1\mid W=w)}</span></span>
<span id="cb15-452"><a href="#cb15-452"></a><span class="co">  {\text{odds}(A = 1\mid W=w)}.</span></span>
<span id="cb15-453"><a href="#cb15-453"></a><span class="co">\end{equation*}</span></span>
<span id="cb15-454"><a href="#cb15-454"></a><span class="co">* In our analysis, we will modulate the _odds of participating in a sports</span></span>
<span id="cb15-455"><a href="#cb15-455"></a><span class="co">  team_ by a fixed amount for each individual, setting, for example,</span></span>
<span id="cb15-456"><a href="#cb15-456"></a><span class="co">  $\delta = 2$:</span></span>
<span id="cb15-457"><a href="#cb15-457"></a><span class="co">```{r delta_ipsi}</span></span>
<span id="cb15-458"><a href="#cb15-458"></a><span class="co">delta_shift_ipsi &lt;- 2</span></span>
<span id="cb15-459"><a href="#cb15-459"></a><span class="co">```</span></span>
<span id="cb15-460"><a href="#cb15-460"></a><span class="co">* Such an intervention may be interpreted as the effect of a school program</span></span>
<span id="cb15-461"><a href="#cb15-461"></a><span class="co">  that motivates children to participate in sports teams.</span></span>
<span id="cb15-462"><a href="#cb15-462"></a></span>
<span id="cb15-463"><a href="#cb15-463"></a><span class="al">###</span><span class="co"> Efficient estimation of the stochastic (in)direct effects</span></span>
<span id="cb15-464"><a href="#cb15-464"></a></span>
<span id="cb15-465"><a href="#cb15-465"></a><span class="co">* The decomposition of the PIE into the direct and indirect effects leads to a</span></span>
<span id="cb15-466"><a href="#cb15-466"></a><span class="co">  common term $\E[Y_{\color{red}{A_\delta},\color{blue}{M}}]$ involved in both</span></span>
<span id="cb15-467"><a href="#cb15-467"></a><span class="co">  the direct and indirect effect definitions. This term may be estimated via</span></span>
<span id="cb15-468"><a href="#cb15-468"></a><span class="co">  the [`medshift` `R` package](https://github.com/nhejazi/medshift)</span></span>
<span id="cb15-469"><a href="#cb15-469"></a><span class="co">  [@hejazi2020medshift].</span></span>
<span id="cb15-470"><a href="#cb15-470"></a><span class="co">* For the direct effect, the remaining term is the</span></span>
<span id="cb15-471"><a href="#cb15-471"></a><span class="co">  $\E[Y_{\color{blue}{A},\color{red}{M}}]$, which may be estimated by a simple</span></span>
<span id="cb15-472"><a href="#cb15-472"></a><span class="co">  mean in the observed data (i.e., no intervention).</span></span>
<span id="cb15-473"><a href="#cb15-473"></a><span class="co">* For the indirect effect, the remaining term is the joint effect of stochastic</span></span>
<span id="cb15-474"><a href="#cb15-474"></a><span class="co">  interventions on both $A$ and $M$:</span></span>
<span id="cb15-475"><a href="#cb15-475"></a><span class="co">  $\E[Y_{\color{red}{A_\delta},\color{blue}{M_{A_\delta</span><span class="re">}}}</span><span class="co">$.</span></span>
<span id="cb15-476"><a href="#cb15-476"></a><span class="co">  * For the case of an IPSI on binary $A$, this may be estimated by the tools</span></span>
<span id="cb15-477"><a href="#cb15-477"></a><span class="co">    in the [`npcausal` `R` package](https://github.com/ehkennedy/npcausal).</span></span>
<span id="cb15-478"><a href="#cb15-478"></a><span class="co">  * For the case of an MTP on continuous $A$, this may be estimated by the</span></span>
<span id="cb15-479"><a href="#cb15-479"></a><span class="co">    tools in the [`txshift` `R` package](https://github.com/nhejazi/txshift)</span></span>
<span id="cb15-480"><a href="#cb15-480"></a><span class="co">    [@hejazi2020txshift-rpkg; @hejazi2020txshift-joss].</span></span>
<span id="cb15-481"><a href="#cb15-481"></a><span class="co">* Like the implementation in `medoutcon`, the `medshift` package makes use of</span></span>
<span id="cb15-482"><a href="#cb15-482"></a><span class="co">  cross-validation in constructing initial estimates of nuisance parameters,</span></span>
<span id="cb15-483"><a href="#cb15-483"></a><span class="co">  resulting in more robust, cross-validated efficient estimators</span></span>
<span id="cb15-484"><a href="#cb15-484"></a><span class="co">  [@klaassen1987consistent; @zheng2011cross; @chernozhukov2018double].</span></span>
<span id="cb15-485"><a href="#cb15-485"></a><span class="co">* Now, we're ready to use the `medshift` function to estimate the decomposition</span></span>
<span id="cb15-486"><a href="#cb15-486"></a><span class="co">  term common to both the _stochastic direct and indirect effects_:</span></span>
<span id="cb15-487"><a href="#cb15-487"></a><span class="co">  ```{r stoch_decomp_os}</span></span>
<span id="cb15-488"><a href="#cb15-488"></a><span class="co">  # compute one-step estimate of decomposition term of the (in)direct effects</span></span>
<span id="cb15-489"><a href="#cb15-489"></a><span class="co">  stoch_decomp_onestep &lt;- medshift(</span></span>
<span id="cb15-490"><a href="#cb15-490"></a><span class="co">    W = weight_behavior[, c("age", "sex", "race", "tvhours")],</span></span>
<span id="cb15-491"><a href="#cb15-491"></a><span class="co">    A = (as.numeric(weight_behavior$sports) - 1),</span></span>
<span id="cb15-492"><a href="#cb15-492"></a><span class="co">    Z = weight_behavior[, c("snack", "exercises", "overweigh")],</span></span>
<span id="cb15-493"><a href="#cb15-493"></a><span class="co">    Y = weight_behavior$bmi,</span></span>
<span id="cb15-494"><a href="#cb15-494"></a><span class="co">    delta = delta_shift_ipsi,</span></span>
<span id="cb15-495"><a href="#cb15-495"></a><span class="co">    g_learners = lasso_lrnr,</span></span>
<span id="cb15-496"><a href="#cb15-496"></a><span class="co">    e_learners = lasso_lrnr,</span></span>
<span id="cb15-497"><a href="#cb15-497"></a><span class="co">    m_learners = lasso_lrnr,</span></span>
<span id="cb15-498"><a href="#cb15-498"></a><span class="co">    estimator = "onestep",</span></span>
<span id="cb15-499"><a href="#cb15-499"></a><span class="co">    estimator_args = list(cv_folds = 5)</span></span>
<span id="cb15-500"><a href="#cb15-500"></a><span class="co">  )</span></span>
<span id="cb15-501"><a href="#cb15-501"></a><span class="co">  summary(stoch_decomp_onestep)</span></span>
<span id="cb15-502"><a href="#cb15-502"></a><span class="co">  ```</span></span>
<span id="cb15-503"><a href="#cb15-503"></a></span>
<span id="cb15-504"><a href="#cb15-504"></a><span class="co">* To estimate the stochastic direct effect, an extra step is necessary -- we</span></span>
<span id="cb15-505"><a href="#cb15-505"></a><span class="co">  must apply the delta method:</span></span>
<span id="cb15-506"><a href="#cb15-506"></a><span class="co">  ```{r linear_contrast_delta}</span></span>
<span id="cb15-507"><a href="#cb15-507"></a><span class="co">  # convenience function to compute inference via delta method: EY1 - EY0</span></span>
<span id="cb15-508"><a href="#cb15-508"></a><span class="co">  linear_contrast &lt;- function(params, eifs, ci_level = 0.95) {</span></span>
<span id="cb15-509"><a href="#cb15-509"></a><span class="co">    # bounds for confidence interval</span></span>
<span id="cb15-510"><a href="#cb15-510"></a><span class="co">    ci_norm_bounds &lt;- c(-1, 1) * abs(stats::qnorm(p = (1 - ci_level) / 2))</span></span>
<span id="cb15-511"><a href="#cb15-511"></a><span class="co">    param_est &lt;- params[[1]] - params[[2]]</span></span>
<span id="cb15-512"><a href="#cb15-512"></a><span class="co">    eif &lt;- eifs[[1]] - eifs[[2]]</span></span>
<span id="cb15-513"><a href="#cb15-513"></a><span class="co">    se_eif &lt;- sqrt(var(eif) / length(eif))</span></span>
<span id="cb15-514"><a href="#cb15-514"></a><span class="co">    param_ci &lt;- param_est + ci_norm_bounds * se_eif</span></span>
<span id="cb15-515"><a href="#cb15-515"></a><span class="co">    # parameter and inference</span></span>
<span id="cb15-516"><a href="#cb15-516"></a><span class="co">    out &lt;- c(param_ci[1], param_est, param_ci[2])</span></span>
<span id="cb15-517"><a href="#cb15-517"></a><span class="co">    names(out) &lt;- c("lwr_ci", "param_est", "upr_ci")</span></span>
<span id="cb15-518"><a href="#cb15-518"></a><span class="co">    return(out)</span></span>
<span id="cb15-519"><a href="#cb15-519"></a><span class="co">  }</span></span>
<span id="cb15-520"><a href="#cb15-520"></a><span class="co">  ```</span></span>
<span id="cb15-521"><a href="#cb15-521"></a><span class="co">* Straightforward application of this procedure yields,</span></span>
<span id="cb15-522"><a href="#cb15-522"></a><span class="co">  ```{r stoch_de_ipsi}</span></span>
<span id="cb15-523"><a href="#cb15-523"></a><span class="co">  # parameter estimates and EIFs for components of direct effect</span></span>
<span id="cb15-524"><a href="#cb15-524"></a><span class="co">  EY &lt;- mean(weight_behavior$bmi)</span></span>
<span id="cb15-525"><a href="#cb15-525"></a><span class="co">  eif_EY &lt;- weight_behavior$bmi - EY</span></span>
<span id="cb15-526"><a href="#cb15-526"></a><span class="co">  params_de &lt;- list(stoch_decomp_onestep$theta, EY)</span></span>
<span id="cb15-527"><a href="#cb15-527"></a><span class="co">  eifs_de &lt;- list(stoch_decomp_onestep$eif, eif_EY)</span></span>
<span id="cb15-528"><a href="#cb15-528"></a></span>
<span id="cb15-529"><a href="#cb15-529"></a><span class="co">  # direct effect = EY - estimated quantity</span></span>
<span id="cb15-530"><a href="#cb15-530"></a><span class="co">  de_est &lt;- linear_contrast(params_de, eifs_de)</span></span>
<span id="cb15-531"><a href="#cb15-531"></a><span class="co">  de_est</span></span>
<span id="cb15-532"><a href="#cb15-532"></a><span class="co">  ```</span></span>
<span id="cb15-533"><a href="#cb15-533"></a><span class="co">* From the above, we can conclude that the effect of increasing the odds of</span></span>
<span id="cb15-534"><a href="#cb15-534"></a><span class="co">  participation on a sports team on BMI leads only to a relatively small direct</span></span>
<span id="cb15-535"><a href="#cb15-535"></a><span class="co">  effect.</span></span>
<span id="cb15-536"><a href="#cb15-536"></a><span class="co">--&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nhejazi/ser2024_mediation_workshop/edit/master/chapters/estimation_walkthrough.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nhejazi/ser2024_mediation_workshop/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>